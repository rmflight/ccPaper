# Muscle Skin Data processing

How do we process the data for muscle and skin to something we can start running through `categoryCompare`?

```{r loadLibraries}
options(stringsAsFactors=TRUE)
library(affy)
```

## Skin

Get the raw data in (this should actually be on GEO, but doesn't seem to be there yet)

```{r skinRaw, eval=FALSE}
currLoc <- getwd()
dataLoc <- "/mlab/data/rmflight/Documents/projects/work/Petruska/drg_sc_skin_denervation/Skin/"
setwd(dataLoc)

attFile <- "Sample information file.txt"
dataAttributes <- read.table(attFile, sep="\t", header=T)
dataAttributes$timePoint <- 0
dataAttributes$timePoint[(dataAttributes$Time == "7 day")] <- 7
dataAttributes$timePoint[(dataAttributes$Time == "14 day")] <- 14

celData <- ReadAffy(phenoData=dataAttributes)
skinData <- rma(celData)

setwd(currLoc)
.sessionInfo <- sessionInfo()
.timeDate <- Sys.time()
save(skinData, .sessionInfo, .timeDate, file="inst/data/skin_rma_data.RData")
```

## Muscle

```{r muscleRaw, eval=FALSE}
library(GEOquery)
muscleData <- getGEO(GEO="GSE4411")[[1]]

controlSamples <- grep("Control", pData(muscleData)$title)
muscleData <- muscleData[,controlSamples]

tmpP <- pData(muscleData)
tmpP$innervation <- "innervated"
denLoc <- grep("Denervated", tmpP$title)
tmpP$innervation[denLoc] <- "denervated"
pData(muscleData) <- tmpP
.sessionInfo <- sessionInfo()
.timeDate <- Sys.time()
save(muscleData, .sessionInfo, .timeDate, file="inst/data/muscle_data.RData")
```

# Gene Lists

For both the skin and muscle data sets, we will calculate the p-values using `limma`. We will probably attempt to do both hypergeometric enrichment and GSEA.

Do not forget that these are from different organisms. **Skin**: rat, **muscle**: mouse.

## Skin Gene Lists and Enrichment

```{r diffSkin}
library(limma)
library(rat2302.db)
load("inst/data/skin_rma_data.RData")

skinComps <- c("T7 - T0", "T14 - T0")
geneID <- unlist(mget(featureNames(skinData), rat2302ENTREZID))

skinExpr <- exprs(skinData)
skinCollapse <- collapseProbes(skinExpr, geneID) # collapse to single genes using median of expression
skinCharacter <- pData(skinData)
skinCharacter$timePoint2 <- paste("T", skinCharacter$timePoint, sep="")

skinFC <- rankGenes(skinCollapse, skinCharacter$timePoint2, skinComps, doAggregation=FALSE, aggregateIndex=NA)
names(skinFC) <- c("T7", "T14")

skinDiff <- lapply(skinFC, getDiffGenes, id="id")
```


```{r setupGeneSets}
library(GO.db)
library(org.Rn.eg.db)
library(limma)
rnGO <- as.list(org.Rn.egGO2ALLEGS)
rnGO <- rnGO[(Ontology(names(rnGO)) == "BP")]
rnGO <- lapply(rnGO, unique)

skinSet <- symbols2indices(rnGO, rownames(skinCollapse))
```


```{r skinContrasts}
skinStatus <- skinCharacter$timePoint2
f <- factor(skinStatus)
skinDesign <- model.matrix(~0 + f)
colnames(skinDesign) <- levels(f)

skinContrast <- makeContrasts(contrasts=skinComps, levels=skinDesign)

save(list=ls(), file="runSkinRomer.RData")
```

```{r skinRomer, eval=FALSE}
load("runSkinRomer.RData")
options(mc.cores=12) # at least if we are on hera
t1 <- Sys.time()
skinRomer <- multicontrastRomer(skinSet, skinCollapse, skinDesign, skinContrast, nrot=10000)
names(skinRomer) <- c("T7", "T14")
save(skinRomer, file="inst/data/skinRomer.RData")
t2 <- Sys.time()
difftime(t2, t1)
```


Run using `geneSetTest`

```{r runGeneSetTest}
load("runSkinRomer.RData")
options(mc.cores=12) # at least if we are on hera
t1 <- Sys.time()
skinGeneSetTest <- lapply(skinFC, function(x){
  mmGeneSetTest(skinSet, x$t)
})

t2 <- Sys.time()
difftime(t2, t1)
save(skinGeneSetTest, t1, t2, file="inst/data/skinGeneSetTest.RData")
```


## Muscle Gene Lists and Enrichment


```{r diffMuscle}
library(limma)
library(mouse4302.db)
load("inst/data/muscle_data.RData")

muscleComps <- c("denervated - innervated")
geneID <- unlist(mget(featureNames(muscleData), mouse4302ENTREZID))

muscleExpr <- exprs(muscleData)
muscleCollapse <- collapseProbes(muscleExpr, geneID) # collapse to single genes using median of expression
muscleCharacter <- pData(muscleData)

muscleFC <- rankGenes(muscleCollapse, muscleCharacter$innervation, muscleComps, doAggregation=FALSE, aggregateIndex=NA)
names(muscleFC) <- "denervation"

muscleDiff <- lapply(muscleFC, getDiffGenes, id="id")
```

```{r setupGeneSetsMuscle}
library(GO.db)
library(org.Mm.eg.db)
library(limma)
mmGO <- as.list(org.Mm.egGO2ALLEGS)
mmGO <- mmGO[(Ontology(names(mmGO)) == "BP")]
mmGO <- lapply(mmGO, unique)

muscleSet <- symbols2indices(mmGO, rownames(muscleCollapse))
```


```{r muscleContrasts}
muscleStatus <- muscleCharacter$innervation
f <- factor(muscleStatus)
muscleDesign <- model.matrix(~0 + f)
colnames(muscleDesign) <- levels(f)

muscleContrast <- makeContrasts(contrasts=muscleComps, levels=muscleDesign)

save(muscleSet, muscleCollapse, muscleDesign, muscleContrast, mmGO, muscleFC, file="runMuscleRomer.RData")
```

```{r muscleRomer, eval=FALSE}
load("runMuscleRomer.RData")
options(mc.cores=12) # at least if we are on hera
t1 <- Sys.time()
muscleRomer <- multicontrastRomer(muscleSet, muscleCollapse, muscleDesign, muscleContrast, nrot=10000)
names(muscleRomer) <- "denervation"
save(muscleRomer, file="inst/data/muscleRomer.RData")
t2 <- Sys.time()
difftime(t2, t1)
```


Run using `geneSetTest`

```{r runGeneSetTestMuscle}
load("runMuscleRomer.RData")
options(mc.cores=12) # at least if we are on hera
t1 <- Sys.time()
muscleGeneSetTest <- lapply(muscleFC, function(x){
  mmGeneSetTest(muscleSet, x$t)
})

t2 <- Sys.time()
difftime(t2, t1)
save(muscleGeneSetTest, t1, t2, file="inst/data/muscleGeneSetTest.RData")
```